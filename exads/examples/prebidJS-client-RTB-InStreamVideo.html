<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <title>RTB Instream Video Prebid.js</title>

    <link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.css"
          integrity="sha512-0gIqgiX1dWTChdWUl8XGIBDFvLo7aTvmd6FAhJjzWx5bzYsCJTiPJLKqLF3q31IN4Kfrc0NbTO+EthoT6O0olQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.css"
          integrity="sha512-vvsEsf+dZDp6wbommO1Jbb2bpFhVQjw6pIzfE5fUY5Fgkmsgn/16sQWegqrd236T69kK5F1SbGZ+yK46a9il5A=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://vjs.zencdn.net/7.20.2/video.js"></script>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.js"
            integrity="sha512-XjyyAijQGlXZET35toG8igvVs8HvfVgKXGnbfAs2EpZ0o8vjJoIrxL9RBBQbQjzAODIe0jvWelFfZOA3Z/vdWg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.js"
            integrity="sha512-SCLZezhUawfgEVvtAuWp8OpRjZVa30okAsUoUe4+wPO6BEj4dWV1rDDruNwgOUrNdKpJL0GBf0KRrslSO7nqrw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-playlist@5.1.0/dist/videojs-playlist.min.js"></script>

    <!-- Uncomment for development environments -->
    <!-- <script src='js/prebid.js'></script> -->
    <!-- Uncomment for production environments -->
    <script async src='js/prebid.js' onload='onScriptLoaded()'></script>

    <script>
        // Client Conf start
        // Set as true for development environments only
        const isEnabledDebug = false;
        const exadsEndpoint = 'https://your-ad-network.com/rtb.php';
        const partner = 'ortb_2_4';
        let zoneId = 5208095;
        let fid = '56aa7575210d931d37f62d816a84d4afdb2dfa97';

        // Start GDPR params
        let isGDPRRequested = false;
        // Valid iabtcf consent string 
        let consentString = 'CO_V33gP0l1PgAoAAAENCZCgAAAAAAAAAAAAE0wAQE0gTTABATSAAA.YAAAAAAAAAA';
        // End GDPR params

        let siteId = '12345';
        let siteName = 'your-site.com';
        let country = 'IRL';
        let keywords = 'lifestyle, humour';
        let bidfloorcur = 'EUR';
        let bidfloor = 0.00000011;
        // Client Conf end
        let adUnits = [];

        let PREBID_TIMEOUT = 500000;
        let userIp = 0;
        let userIpLoaded = false;
        let impressionId = hashCode(new Date().getTime().toString());
        let userId = localStorage.getItem('prebidJS.userId');      

        if (!userId) {
            localStorage.setItem('prebidJS.userId', hashCode('userId' + new Date().getTime().toString()));
            userId = localStorage.getItem('prebidJS.userId');
        }

        let ipScript = document.createElement('script');
        ipScript.type = 'text/javascript';
        ipScript.src = 'https://api.ipify.org?format=jsonp&callback=userIpCallback';
        document.getElementsByTagName('head')[0].appendChild(ipScript);

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        handleRTB();

        if (isEnabledDebug) {
            onScriptLoaded();
        }

        function onScriptLoaded() {

        }

        // ======== DO NOT EDIT BELOW THIS LINE =========== //
        function userIpCallback(user_ip) {
            userIpLoaded = true;
            if (user_ip.hasOwnProperty('ip')) {
                userIp = user_ip.ip;
            } 
        }

        // MurmurHash3 hash function
        function hashCode(str, seed = 0) {
            let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
            for (let i = 0, ch; i < str.length; i++) {
                ch = str.charCodeAt(i);
                h1 = Math.imul(h1 ^ ch, 2654435761);
                h2 = Math.imul(h2 ^ ch, 1597334677);
            }
            h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
            h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
            return 4294967296 * (2097151 & h2) + (h1 >>> 0);
        }

        function handleRTB() {
            adUnits = [{
                code: 'postbid_iframe',
                mediaTypes: {
                    video: {
                        mimes: ['video/mp4'],
                        protocols: [3, 6, 2],
                        divId: 'player', // required to indicate which player is being used to render this ad unit.
                    }
                },
                bids: [{
                    bidder: 'exads',
                    params: {
                        zoneId: zoneId,
                        fid: fid,
                        partner: partner,
                        siteId: siteId,
                        siteName: siteName,
                        userIp: 0, // DO NOT EDIT - Client side data
                        userId: userId,
                        impressionId: impressionId.toString(), // DO NOT EDIT - Custom hash
                        imp: {                            
                            ext: {
                                video_cta: 0
                            }
                        },
                        dsa: {
                            dsarequired: 3, 
                            pubrender: 0,
                            datatopub: 2
                        },
                        country: country,
                        keywords: keywords,
                        bidfloor: bidfloor,
                        bidfloorcur: bidfloorcur,
                        bcat: ['IAB25', 'IAB7-39','IAB8-18','IAB8-5','IAB9-9'],
                        badv: ['first.com', 'second.com'],                        
                        endpoint: exadsEndpoint
                    }
                }]
            }];
        }

        // Init when IP data is available
        function initBids() {
            if (userIpLoaded === false) {
                window.setTimeout(initBids, 50);
            } else {
                for (let i = 0; i < adUnits.length; i++) {
                    for (let t = 0; t < adUnits[i].bids.length; t++) {
                        adUnits[i].bids[t].params.userIp = userIp;
                    }
                }

                pbjs.que.push(function () {
                    pbjs.setConfig({
                        debug: isEnabledDebug,
                        cache: { url: 'https://prebid.adnxs.com/pbc/v1/cache' },
                        consentManagement: {
                            gdpr: {
                                cmpApi: 'static',
                                timeout: 1000000,
                                defaultGdprScope: true,
                                consentData: {
                                    getTCData: {
                                        tcString: consentString,
                                        gdprApplies: isGDPRRequested
                                    }
                                }
                            }
                        },
                        video: {
                            providers: [{
                                divId: 'player',
                                vendorCode: 2, // videojs vendorCode
                                playerConfig: {
                                    params: {
                                        adPluginConfig: {
                                            numRedirects: 10
                                        },
                                        vendorConfig: {
                                            controls: true,
                                            autoplay: true,
                                            preload: "auto",
                                        }
                                    }
                                }
                            },]
                        },
                    });
                    pbjs.addAdUnits(adUnits);

                    pbjs.onEvent('videoSetupComplete', e => {
                        const player = videojs('player');
                        // Load the playlist items with their metadata when the video player is done instantiating.
                        player.playlist([{
                            sources: [{
                                src: 'https://vjs.zencdn.net/v/oceans.mp4',
                                type: 'video/mp4'
                            }]
                        }]);

                        player.playlist.autoadvance(0);
                    });

                    pbjs.onEvent('videoSetupFailed', e => {
                        console.log('player setup failed: ', e);
                    });

                    pbjs.onEvent('videoPlaylist', (e) => {
                        console.log('videos pb playlist: ', e);
                    });

                    pbjs.onEvent('videoContentLoaded', (e) => {
                        console.log('videos pb contentLoaded: ', e);
                    });

                    pbjs.onEvent('videoComplete', (e) => {
                        console.log('videos pb complete: ', e);
                    });

                    //pbjs.requestBids(adUnits);
                    pbjs.requestBids({
                        timeout: PREBID_TIMEOUT,
                        bidsBackHandler: function (bidResponses) {
                            const bidResponse = bidResponses['postbid_iframe'];
                            if (!bidResponse) {
                                return;
                            }

                            bidResponse.bids.forEach(bid => {
                                pbjs.videoModule.renderBid('player', bid);
                            });
                        }
                    });
                });
            }
        }

        initBids();

    </script>

</head>

<body>

    <h2>RTB Instream Video Prebid.js</h2>
    <video-js id='player' class="vjs-big-play-centered" muted="'true">
    </video-js>
</body>

</html>